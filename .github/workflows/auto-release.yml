name: Auto Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

jobs:
  create-release:
    name: Create Release Tag
    runs-on: ubuntu-latest
    outputs:
      tag_created: ${{ steps.set_output.outputs.tag_created }}
      new_version: ${{ steps.new_version.outputs.new_version }}
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get current version from git tags
      id: get_version
      run: |
        # Get the latest tag, or default to 0.0.0
        CURRENT_VERSION=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1 | sed 's/^v//' || echo "0.0.0")
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"
    
    - name: Determine version bump type
      id: bump_type
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          BUMP_TYPE="${{ github.event.inputs.version_bump }}"
        else
          # Auto-detect from commit messages
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -qiE "^(breaking|major):"; then
            BUMP_TYPE="major"
          elif echo "$COMMIT_MSG" | grep -qiE "^(feat|feature|minor):"; then
            BUMP_TYPE="minor"
          else
            BUMP_TYPE="patch"
          fi
        fi
        echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
        echo "Version bump type: $BUMP_TYPE"
    
    - name: Calculate new version
      id: new_version
      run: |
        CURRENT="${{ steps.get_version.outputs.current_version }}"
        BUMP_TYPE="${{ steps.bump_type.outputs.bump_type }}"
        
        IFS='.' read -r major minor patch <<< "$CURRENT"
        major=${major:-0}
        minor=${minor:-0}
        patch=${patch:-0}
        
        if [ "$BUMP_TYPE" == "major" ]; then
          major=$((major + 1))
          minor=0
          patch=0
        elif [ "$BUMP_TYPE" == "minor" ]; then
          minor=$((minor + 1))
          patch=0
        else
          patch=$((patch + 1))
        fi
        
        NEW_VERSION="${major}.${minor}.${patch}"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "New version: $NEW_VERSION"
    
    - name: Check if tag already exists
      id: check_tag
      run: |
        TAG_NAME="v${{ steps.new_version.outputs.new_version }}"
        if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Tag $TAG_NAME already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Tag $TAG_NAME does not exist"
        fi
    
    - name: Create and push tag
      id: create_tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        TAG_NAME="v${{ steps.new_version.outputs.new_version }}"
        git config --local user.email "info@togomq.io"
        git config --local user.name "TogoMQ CI Bot"
        git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
        git push origin "$TAG_NAME"
        echo "Created and pushed tag: $TAG_NAME"
    
    - name: Skip release (tag exists)
      if: steps.check_tag.outputs.exists == 'true'
      run: |
        echo "Tag v${{ steps.new_version.outputs.new_version }} already exists. Skipping release."
    
    - name: Release complete
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "âœ… Tag v${{ steps.new_version.outputs.new_version }} created successfully!"
        echo "Packagist will be automatically updated via webhook."
